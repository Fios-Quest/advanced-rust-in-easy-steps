<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>TypeState - Software Patterns and Coding Excellence</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Even more Rust idioms, patterns and useful tricks">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Software Patterns and Coding Excellence</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="typestate"><a class="header" href="#typestate">Typestate</a></h1>
<p>The typestate pattern encodes state into type information. This is useful because this information exists when you
write the program but not when you run it, allowing you to enforce domain logic with minimal overhead.</p>
<h2 id="state"><a class="header" href="#state">State</a></h2>
<p>Lets imagine a simplified pull request process. We can open a new pull request, which then must be approved by at least
one person, before it’s merged. Multiple people can approve it, but if anyone rejects it (even after its approved) it
can no longer be merged.</p>
<pre><code class="language-mermaid">%%{ init: { 'flowchart': {'defaultRenderer': 'elk' } } }%%
flowchart LR
    A ---&gt;|foo| B
    B ---&gt;|bar| B
</code></pre>
<pre><code class="language-mermaid">---
config:
  layout: elk
---
flowchart LR
    O[Open]
    A[Approved]
    R[Rejected]
    M[Merged]

    O -- Approve --&gt; A
    A -- Approve --&gt; A
    O -- Reject --&gt; R
    A -- Reject --&gt; R
    A -- Merge --&gt; M
</code></pre>
<p>Let’s try to model one small part of this flow in a traditional way, the “approve” action.</p>
<p>First lets model it with a PullRequest type that <em>has</em> a status. A PR can be approved if the status is ReadyForReview or
Approved. If the status was not one of those, then we’ll need to return an error to say that the status could not be
changed.</p>
<pre><pre class="playground"><code class="language-rust edition2024">struct InvalidStateError;

#[derive(Debug, PartialEq)]
enum Status {
    Open,
    Approved,
    Rejected,
    Merged
}

struct PullRequest {
    status: Status,
    // ...other PR details ...
}

impl PullRequest {
    fn approve(&amp;mut self) -&gt; Result&lt;(), InvalidStateError&gt; {
        if self.status == Status::Open || self.status == Status::Approved {
            self.status = Status::Approved;
            Ok(())
        } else {
            Err(InvalidStateError)
        }
    }

    fn reject(&amp;mut self) -&gt; Result&lt;(), InvalidStateError&gt; {
        if self.status == Status::Open || self.status == Status::Approved {
            self.status = Status::Rejected;
            Ok(())
        } else {
            Err(InvalidStateError)
        }
    }

    fn merge(&amp;mut self) -&gt; Result&lt;(), InvalidStateError&gt; {
        if self.status == Status::Approved {
            self.status = Status::Merged;
            Ok(())
        } else {
            Err(InvalidStateError)
        }
    }
}
<span class="boring">
</span><span class="boring">fn main () {
</span>// You can approve a PR that's just been opened or already Approved
let mut pr = PullRequest { status: Status::Open };
assert!(pr.approve().is_ok());
assert_eq!(pr.status, Status::Approved);
assert!(pr.approve().is_ok());

// You can not approve or merge rejected PR
let mut pr = PullRequest { status: Status::Rejected };
assert!(pr.approve().is_err());
assert!(pr.merge().is_err());
<span class="boring">}</span></code></pre></pre>
<p>We’ve written up our three state change operations but we’ve had to write a lot of branching logic into each method to
check that the operation is only being run on a PR in a valid state. If it wasn’t in a valid state we produce errors
that now need to be dealt with.</p>
<pre><pre class="playground"><code class="language-rust edition2024">struct PullRequestOpen {
    // ...other PR details ...
}

struct PullRequestApproved {
    // ...other PR details ...
}

struct PullRequestRejected {
    // ...other PR details ...
}

struct PullRequestMerged {
    // ...other PR details...
}

impl PullRequestOpen {
    fn approve(self) -&gt; PullRequestApproved {
        PullRequestApproved {
            // ... move self into PullRequestApproved ...
        }
    }

    fn reject(self) -&gt; PullRequestRejected {
        PullRequestRejected {
            // ... move self into PullRequestApproved ...
        }
    }
}

impl PullRequestApproved {
    fn approve(self) -&gt; PullRequestApproved {
        self
    }

    fn reject(self) -&gt; PullRequestRejected {
        PullRequestRejected {
            // ... move self into PullRequestApproved ...
        }
    }

    fn merge(self) -&gt; PullRequestMerged {
        PullRequestMerged {
            // ... move self into PullRequestApproved ...
        }
    }
}

<span class="boring">
</span><span class="boring">fn main () {
</span>let open_pr = PullRequestOpen { };

// You can not merge an open PR, the next line won't compile
// let merged_pr = open_pr.merge();

// You can approve a PR with Ready for Review or already Approved
let approved_pr = open_pr.approve();
let still_approved = approved_pr.approve();

// Then it can be merged
let merged_pr = still_approved.merge();

// The `.approve()` method doesn't exist for rejected PRs, commented line won't compile
let rejected_pr = PullRequestRejected { };
// rejected_pr.approve();
<span class="boring">}</span></code></pre></pre>
<h2 id="pros-and-cons"><a class="header" href="#pros-and-cons">Pros and Cons</a></h2>
<p>Utilising the typestate pattern requires writing a lot more code <em>but</em> that code has fewer branches, fewer (or in this
case no) potential error states, and everything is logically subdivided making maintaining the code more trivial.</p>
<p>In the example we’ve given here, we consume the type each time we change state. Generally in Rust it’s better to pass
references rather than ownership, but in the case of transitioning state we want to return a new type. Often the old
type will contain owned data that needs to be moved to the new type, and we’ll rarely want to keep the old state around
but your needs may differ. If you regularly need to keep the old state you could pass by reference, but if you only
occasionally need to keep the old state, you could clone it first.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../patterns/newtype.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../patterns/builder.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../patterns/newtype.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../patterns/builder.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
